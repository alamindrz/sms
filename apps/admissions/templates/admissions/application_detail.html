{% extends 'base.html' %}
{% load static %}

{% block title %}Application Details - EduSys Pro{% endblock %}
{% block page_title %}{{ application.application_number }}{% endblock %}
{% block page_subtitle %}{{ application.full_name }}{% endblock %}

{% block header_actions %}
<div class="flex items-center space-x-3">
    <a href="{% url 'admissions:application_list' %}" 
       class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>Back to List
    </a>
    {% if perms.admissions.review_application and application.can_be_reviewed %}
    <a href="{% url 'admissions:application_review' application.pk %}" 
       class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
        <i class="fas fa-search mr-2"></i>Review Application
    </a>
    {% endif %}
    {% if perms.admissions.make_admission_decision and application.can_be_decided %}
    <a href="{% url 'admissions:application_decision' application.pk %}" 
       class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
        <i class="fas fa-bullhorn mr-2"></i>Make Decision
    </a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Student Information -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Application Status Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Application Status</h3>
                <span class="px-3 py-1 rounded-full text-sm font-medium
                    {% if application.status == 'approved' %}bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300
                    {% elif application.status == 'pending' %}bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300
                    {% elif application.status == 'under_review' %}bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300
                    {% elif application.status == 'rejected' %}bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300
                    {% elif application.status == 'waitlisted' %}bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300
                    {% else %}bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-300{% endif %}">
                    {{ application.get_status_display }}
                </span>
            </div>
            
            <!-- Progress Steps -->
            <div class="relative pt-1">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full {% if application.payment_verified %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %} flex items-center justify-center">
                            {% if application.payment_verified %}
                            <i class="fas fa-check text-white text-xs"></i>
                            {% endif %}
                        </div>
                        <span class="ml-2 text-sm font-medium {% if application.payment_verified %}text-green-600 dark:text-green-400{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                            Payment Verified
                        </span>
                    </div>
                    <div class="flex-1 h-1 mx-4 {% if application.status != 'pending' %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}"></div>
                    
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full {% if application.status != 'pending' %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %} flex items-center justify-center">
                            {% if application.status != 'pending' %}
                            <i class="fas fa-check text-white text-xs"></i>
                            {% endif %}
                        </div>
                        <span class="ml-2 text-sm font-medium {% if application.status != 'pending' %}text-green-600 dark:text-green-400{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                            Under Review
                        </span>
                    </div>
                    <div class="flex-1 h-1 mx-4 {% if application.status in 'approved,rejected,waitlisted' %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}"></div>
                    
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full {% if application.status in 'approved,rejected,waitlisted' %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %} flex items-center justify-center">
                            {% if application.status in 'approved,rejected,waitlisted' %}
                            <i class="fas fa-check text-white text-xs"></i>
                            {% endif %}
                        </div>
                        <span class="ml-2 text-sm font-medium {% if application.status in 'approved,rejected,waitlisted' %}text-green-600 dark:text-green-400{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                            Decision Made
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Payment Status -->
            <div class="mt-4 p-3 rounded-lg border {% if application.payment_verified %}border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20{% else %}border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20{% endif %}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        {% if application.payment_verified %}
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="font-medium text-green-700 dark:text-green-300">Payment Verified</span>
                        {% elif application.payment_reference %}
                        <i class="fas fa-clock text-amber-500 mr-2"></i>
                        <span class="font-medium text-amber-700 dark:text-amber-300">Payment Pending Verification</span>
                        {% else %}
                        <i class="fas fa-times-circle text-red-500 mr-2"></i>
                        <span class="font-medium text-red-700 dark:text-red-300">No Payment</span>
                        {% endif %}
                    </div>
                    {% if perms.admissions.verify_payment and not application.payment_verified and application.payment_reference %}
                    <a href="{% url 'admissions:verify_payment' application.pk %}" 
                       class="text-sm text-blue-600 dark:text-blue-400 hover:underline">
                        Verify Now
                    </a>
                    {% endif %}
                </div>
                {% if application.payment_reference %}
                <div class="text-sm mt-2">
                    <span class="text-gray-600 dark:text-gray-400">Reference:</span>
                    <span class="font-mono ml-2">{{ application.payment_reference }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Student Information -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Student Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Full Name</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.full_name }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Date of Birth</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.date_of_birth|date:"d M Y" }} ({{ application.age }} years)</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Gender</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.gender }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Religion</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.religion|default:"Not specified" }}</p>
                </div>
                <div class="md:col-span-2">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Previous School</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.previous_school|default:"Not specified" }}</p>
                </div>
            </div>
            
            <!-- Medical Information -->
            {% if application.medical_conditions or application.allergies %}
            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-white mb-2">Medical Information</h4>
                {% if application.medical_conditions %}
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">{{ application.medical_conditions }}</p>
                {% endif %}
                {% if application.allergies %}
                <div class="flex items-center mt-2">
                    <span class="text-xs px-2 py-1 rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">
                        Allergies: {{ application.allergies }}
                    </span>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Guardian Information -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Guardian Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Guardian Name</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.guardian_name }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Relationship</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.guardian_relationship }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Email</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.guardian_email }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Phone</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.guardian_phone }}</p>
                </div>
                <div class="md:col-span-2">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Address</p>
                    <p class="font-medium text-gray-800 dark:text-white">{{ application.guardian_address }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Actions & Timeline -->
    <div class="space-y-6">
        <!-- Quick Actions -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Quick Actions</h3>
            <div class="space-y-3">
                {% if perms.admissions.verify_payment and application.payment_reference and not application.payment_verified %}
                <a href="{% url 'admissions:verify_payment' application.pk %}" 
                   class="block w-full px-4 py-2.5 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors text-center">
                    <i class="fas fa-check-circle mr-2"></i>Verify Payment
                </a>
                {% endif %}
                
                {% if perms.admissions.review_application and application.can_be_reviewed %}
                <a href="{% url 'admissions:application_review' application.pk %}" 
                   class="block w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-center">
                    <i class="fas fa-search mr-2"></i>Review Application
                </a>
                {% endif %}
                
                {% if perms.admissions.make_admission_decision and application.can_be_decided %}
                <a href="{% url 'admissions:application_decision' application.pk %}" 
                   class="block w-full px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-center">
                    <i class="fas fa-bullhorn mr-2"></i>Make Decision
                </a>
                {% endif %}
                
                {% if application.status == 'waitlisted' and perms.admissions.manage_waitlist %}
                <a href="{% url 'admissions:waitlist_manage' application.pk %}" 
                   class="block w-full px-4 py-2.5 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors text-center">
                    <i class="fas fa-list-ol mr-2"></i>Manage Waitlist
                </a>
                {% endif %}
                
                {% if application.status == 'approved' and perms.admissions.send_admission_letter and not application.admission_letter_sent %}
                <a href="{% url 'admissions:send_admission_letter' application.pk %}" 
                   class="block w-full px-4 py-2.5 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-colors text-center">
                    <i class="fas fa-envelope mr-2"></i>Send Admission Letter
                </a>
                {% endif %}
                
                {% if application.status == 'approved' and perms.students.add_student and not application.created_student %}
                <form method="post" 
                      action="{% url 'admissions:create_student_from_application' application.pk %}"
                      onsubmit="return confirm('Create student record from this application?');">
                    {% csrf_token %}
                    <button type="submit" 
                            class="w-full px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>Create Student
                    </button>
                </form>
                {% endif %}
                
                {% if application.created_student %}
                <a href="{% url 'admissions:student_detail' application.created_student.pk %}" 
                   class="block w-full px-4 py-2.5 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors text-center">
                    <i class="fas fa-external-link-alt mr-2"></i>View Student
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Application Details -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Application Details</h3>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Application Number</span>
                    <span class="font-medium text-gray-800 dark:text-white">{{ application.application_number }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Application Date</span>
                    <span class="font-medium text-gray-800 dark:text-white">{{ application.application_date|date:"d M Y" }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Admission Session</span>
                    <span class="font-medium text-gray-800 dark:text-white">{{ application.admission_session|default:"Not set" }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Admission Class</span>
                    <span class="font-medium text-gray-800 dark:text-white">{{ application.admission_class|default:"Not set" }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Application Fee</span>
                    <span class="font-medium text-gray-800 dark:text-white">â‚¦{{ application.payment_amount }}</span>
                </div>
            </div>
        </div>
        <!-- Timeline -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Timeline</h3>
            <div class="space-y-4">
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3">
                        <i class="fas fa-file-alt text-green-600 dark:text-green-400 text-xs"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800 dark:text-white">Application Submitted</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ application.created_at|date:"d M Y H:i" }}</p>
                    </div>
                </div>
                
                {% if application.payment_verified %}
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3">
                        <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-xs"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800 dark:text-white">Payment Verified</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ application.payment_verified_date|date:"d M Y H:i" }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">by {{ application.payment_verified_by }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if application.review_date %}
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                        <i class="fas fa-search text-blue-600 dark:text-blue-400 text-xs"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800 dark:text-white">Application Reviewed</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ application.review_date|date:"d M Y H:i" }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">by {{ application.reviewed_by }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if application.decision_date %}
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full 
                        {% if application.status == 'approved' %}bg-green-100 dark:bg-green-900/30
                        {% elif application.status == 'rejected' %}bg-red-100 dark:bg-red-900/30
                        {% else %}bg-purple-100 dark:bg-purple-900/30{% endif %} 
                        flex items-center justify-center mr-3">
                        <i class="fas fa-bullhorn 
                            {% if application.status == 'approved' %}text-green-600 dark:text-green-400
                            {% elif application.status == 'rejected' %}text-red-600 dark:text-red-400
                            {% else %}text-purple-600 dark:text-purple-400{% endif %} 
                            text-xs"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800 dark:text-white">
                            {{ application.get_status_display }}
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ application.decision_date|date:"d M Y H:i" }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">by {{ application.decision_by }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if application.admission_letter_sent %}
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center mr-3">
                        <i class="fas fa-envelope text-indigo-600 dark:text-indigo-400 text-xs"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800 dark:text-white">Admission Letter Sent</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ application.admission_letter_sent_date|date:"d M Y H:i" }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if application.created_student %}
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3">
                        <i class="fas fa-user-plus text-green-600 dark:text-green-400 text-xs"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800 dark:text-white">Student Created</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Student #{{ application.created_student.student_number }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
