{% extends 'base.html' %}
{% load static %}

{% block title %}Create Student Manually - EduSys Pro{% endblock %}
{% block page_title %}Create Student Manually{% endblock %}
{% block page_subtitle %}Add a new student record with enhanced options{% endblock %}

{% block header_actions %}
<div class="flex items-center space-x-3">
    <a href="{% url 'admissions:student_creation_dashboard' %}" 
       class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
    </a>
</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Progress Steps -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center">
                    <i class="fas fa-user text-sm"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-800 dark:text-white">Student Information</p>
                </div>
            </div>
            <div class="h-1 w-12 bg-gray-300 dark:bg-gray-600"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-400 flex items-center justify-center">
                    <span class="text-sm">2</span>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Guardian Information</p>
                </div>
            </div>
            <div class="h-1 w-12 bg-gray-300 dark:bg-gray-600"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-400 flex items-center justify-center">
                    <span class="text-sm">3</span>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Review & Create</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
        <form method="post" id="studentForm" class="space-y-8">
            {% csrf_token %}
            
            <!-- Section 1: Student Information -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                    <div class="w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center mr-2">
                        <i class="fas fa-user text-indigo-600 dark:text-indigo-400 text-xs"></i>
                    </div>
                    Student Information
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for field in form %}
                        {% if field.name in 'surname,firstname,other_name,gender,date_of_birth,religion' %}
                        <div class="{% if field.name == 'other_name' %}md:col-span-2{% endif %}">
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ field.label }}
                                {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            {{ field }}
                            {% if field.help_text %}
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ field.help_text }}</p>
                            {% endif %}
                            {% if field.errors %}
                            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Section 2: Academic Information -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                    <div class="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-2">
                        <i class="fas fa-graduation-cap text-blue-600 dark:text-blue-400 text-xs"></i>
                    </div>
                    Academic Information
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for field in form %}
                        {% if field.name in 'current_class,current_session' %}
                        <div>
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ field.label }}
                                {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            {{ field }}
                            {% if field.help_text %}
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ field.help_text }}</p>
                            {% endif %}
                            {% if field.errors %}
                            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Auto-assign toggle -->
                    <div class="md:col-span-2">
                        <div class="flex items-center">
                            <input type="checkbox" name="auto_assign_class" id="auto_assign_class" 
                                   class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                            <label for="auto_assign_class" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                                Auto-assign current academic session
                            </label>
                        </div>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            {% if current_session %}
                            Current session: {{ current_session }}
                            {% else %}
                            No current session set in system
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Section 3: Guardian Options -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                    <div class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-2">
                        <i class="fas fa-users text-green-600 dark:text-green-400 text-xs"></i>
                    </div>
                    Guardian Information
                </h3>
                
                <!-- Guardian Options -->
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Option 1: Create New Guardian -->
                        <div>
                            <input type="radio" name="guardian_option" id="new_guardian" value="new" class="hidden peer" checked>
                            <label for="new_guardian" class="block p-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer peer-checked:border-green-500 peer-checked:bg-green-50 dark:peer-checked:bg-green-900/20 hover:border-green-300 dark:hover:border-green-600 transition-all duration-200">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3">
                                        <i class="fas fa-user-plus text-green-600 dark:text-green-400"></i>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-800 dark:text-white">Create New Guardian</h5>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Add new guardian details</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Option 2: Use Existing Guardian -->
                        <div>
                            <input type="radio" name="guardian_option" id="existing_guardian" value="existing" class="hidden peer">
                            <label for="existing_guardian" class="block p-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 hover:border-blue-300 dark:hover:border-blue-600 transition-all duration-200">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                                        <i class="fas fa-search text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-800 dark:text-white">Use Existing Guardian</h5>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Select from existing guardians</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- New Guardian Fields -->
                <div id="newGuardianFields" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% for field in form %}
                            {% if field.name in 'guardian_surname,guardian_firstname,guardian_email,guardian_phone,guardian_relationship' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ field }}
                                {% if field.help_text %}
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ field.help_text }}</p>
                                {% endif %}
                                {% if field.errors %}
                                <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ field.errors }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <div>
                        <label for="{{ form.guardian_address.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ form.guardian_address.label }}
                        </label>
                        {{ form.guardian_address }}
                        {% if form.guardian_address.help_text %}
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ form.guardian_address.help_text }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Existing Guardian Selector -->
                <div id="existingGuardianFields" class="hidden">
                    <div class="mb-4">
                        <label for="{{ form.existing_guardian.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Select Existing Guardian
                        </label>
                        {{ form.existing_guardian }}
                        {% if form.existing_guardian.help_text %}
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ form.existing_guardian.help_text }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Guardian Preview -->
                    <div id="guardianPreview" class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg hidden">
                        <h4 class="font-medium text-gray-800 dark:text-white mb-2">Guardian Preview</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Name:</span>
                                <span id="previewName" class="ml-2 font-medium text-gray-800 dark:text-white"></span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Email:</span>
                                <span id="previewEmail" class="ml-2 font-medium text-gray-800 dark:text-white"></span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Phone:</span>
                                <span id="previewPhone" class="ml-2 font-medium text-gray-800 dark:text-white"></span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Students:</span>
                                <span id="previewStudents" class="ml-2 font-medium text-gray-800 dark:text-white"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Additional Options -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                    <div class="w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mr-2">
                        <i class="fas fa-cog text-purple-600 dark:text-purple-400 text-xs"></i>
                    </div>
                    Additional Options
                </h3>
                
                <div class="space-y-4">
                    <!-- Auto-activate toggle -->
                    <div class="flex items-center">
                        <input type="checkbox" name="auto_activate" id="auto_activate" 
                               class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 dark:focus:ring-green-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                        <label for="auto_activate" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Auto-activate student after creation
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        Student will be activated if all required information is provided (guardian, class, session)
                    </p>
                    
                    <!-- Generate credentials toggle -->
                    <div class="flex items-center">
                        <input type="checkbox" name="generate_credentials" id="generate_credentials" 
                               class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                        <label for="generate_credentials" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Generate login credentials for parent portal
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        Guardian will receive email with login details for parent portal
                    </p>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-lightbulb text-amber-500 mr-1"></i>
                        All required fields must be completed
                    </div>
                    <div class="flex space-x-3">
                        <button type="reset" 
                                class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            Reset Form
                        </button>
                        <button type="submit" 
                                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                            <i class="fas fa-user-plus mr-2"></i>
                            Create Student
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Quick Tips -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mt-6 border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Quick Tips</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-3 rounded-lg border border-blue-200 dark:border-blue-800">
                <div class="flex items-center mb-2">
                    <i class="fas fa-check-circle text-blue-500 mr-2"></i>
                    <h4 class="font-medium text-blue-800 dark:text-blue-300">Complete Information</h4>
                </div>
                <p class="text-sm text-blue-700 dark:text-blue-400">
                    Fill all required fields to enable auto-activation. Students need guardian, class, and session to activate.
                </p>
            </div>
            
            <div class="p-3 rounded-lg border border-green-200 dark:border-green-800">
                <div class="flex items-center mb-2">
                    <i class="fas fa-users text-green-500 mr-2"></i>
                    <h4 class="font-medium text-green-800 dark:text-green-300">Guardian Management</h4>
                </div>
                <p class="text-sm text-green-700 dark:text-green-400">
                    Use existing guardians for siblings. Each guardian can have multiple students.
                </p>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newGuardianRadio = document.getElementById('new_guardian');
    const existingGuardianRadio = document.getElementById('existing_guardian');
    const newGuardianFields = document.getElementById('newGuardianFields');
    const existingGuardianFields = document.getElementById('existingGuardianFields');
    const guardianSelect = document.getElementById('{{ form.existing_guardian.id_for_label }}');
    const guardianPreview = document.getElementById('guardianPreview');
    
    // Guardian data (in real app, this would come from an API)
    const guardianData = {
        {% for guardian in guardians %}
        "{{ guardian.pk }}": {
            name: "{{ guardian.surname }} {{ guardian.firstname }}",
            email: "{{ guardian.email }}",
            phone: "{{ guardian.phone }}",
            students: "{{ guardian.student_set.count }} student{{ guardian.student_set.count|pluralize:'s' }}"
        },
        {% endfor %}
    };
    
    // Toggle guardian fields based on selection
    function toggleGuardianFields() {
        if (newGuardianRadio.checked) {
            newGuardianFields.classList.remove('hidden');
            existingGuardianFields.classList.add('hidden');
            // Mark new guardian fields as required
            document.querySelectorAll('#newGuardianFields [required]').forEach(field => {
                field.required = true;
            });
        } else {
            newGuardianFields.classList.add('hidden');
            existingGuardianFields.classList.remove('hidden');
            // Unmark new guardian fields as required
            document.querySelectorAll('#newGuardianFields [required]').forEach(field => {
                field.required = false;
            });
        }
    }
    
    // Update guardian preview
    function updateGuardianPreview() {
        const guardianId = guardianSelect.value;
        if (guardianId && guardianData[guardianId]) {
            const data = guardianData[guardianId];
            document.getElementById('previewName').textContent = data.name;
            document.getElementById('previewEmail').textContent = data.email;
            document.getElementById('previewPhone').textContent = data.phone;
            document.getElementById('previewStudents').textContent = data.students;
            guardianPreview.classList.remove('hidden');
        } else {
            guardianPreview.classList.add('hidden');
        }
    }
    
    // Event listeners
    newGuardianRadio.addEventListener('change', toggleGuardianFields);
    existingGuardianRadio.addEventListener('change', toggleGuardianFields);
    guardianSelect.addEventListener('change', updateGuardianPreview);
    
    // Initialize
    toggleGuardianFields();
    
    // Form validation
    const form = document.getElementById('studentForm');
    form.addEventListener('submit', function(e) {
        // Validate date of birth
        const dobInput = document.querySelector('input[name="date_of_birth"]');
        if (dobInput && dobInput.value) {
            const dob = new Date(dobInput.value);
            const today = new Date();
            const age = today.getFullYear() - dob.getFullYear();
            
            if (age < 2) {
                e.preventDefault();
                alert('Student must be at least 2 years old.');
                dobInput.focus();
                return;
            }
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            submitBtn.disabled = true;
        }
    });
    
    // Highlight selected guardian option
    document.querySelectorAll('input[name="guardian_option"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('input[name="guardian_option"] + label').forEach(label => {
                label.classList.remove('ring-2', 'ring-offset-2');
            });
            if (this.checked) {
                const label = this.nextElementSibling;
                if (label) {
                    if (this.value === 'new') {
                        label.classList.add('ring-2', 'ring-green-500', 'ring-offset-2');
                    } else {
                        label.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
                    }
                }
            }
        });
        
        // Trigger change on page load
        if (radio.checked) {
            radio.dispatchEvent(new Event('change'));
        }
    });
});
</script>
{% endblock %}
{% endblock %}