{% extends 'base.html' %}
{% load static %}

{% block page_title %}Bulk Student Upload{% endblock %}
{% block page_subtitle %}Upload multiple students via CSV file{% endblock %}

{% block header_actions %}
<a href="{% url 'students:student_list' %}" class="btn btn-secondary flex items-center space-x-2">
  <i class="fas fa-arrow-left"></i>
  <span>Back to List</span>
</a>
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'corecode:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'students:student_list' %}">Students</a></li>
<li class="breadcrumb-item active">Bulk Upload</li>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Left Column: Upload Form & Instructions -->
  <div class="lg:col-span-2">
    <!-- Upload Card -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Upload CSV File</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Upload a CSV file containing student data</p>
      </div>
      
      <div class="p-6">
        {% if form.errors %}
        <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
            <div>
              <h4 class="text-sm font-medium text-red-800 dark:text-red-300">Please correct the errors below</h4>
              <ul class="mt-1 text-sm text-red-700 dark:text-red-400">
                {% for field in form %}
                  {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Upload Area -->
        <div id="uploadArea" 
             class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-8 text-center hover:border-indigo-400 dark:hover:border-indigo-500 transition-colors cursor-pointer"
             ondragover="event.preventDefault(); this.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/10');"
             ondragleave="this.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/10');"
             ondrop="handleDrop(event)">
          <div class="mx-auto w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center mb-4">
            <i class="fas fa-cloud-upload-alt text-indigo-600 dark:text-indigo-400 text-2xl"></i>
          </div>
          
          <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Drop your CSV file here</h4>
          <p class="text-gray-600 dark:text-gray-400 mb-4">or click to browse</p>
          
          <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            <input type="file" 
                   name="csv_file" 
                   id="csv_file" 
                   accept=".csv,text/csv"
                   class="hidden"
                   onchange="handleFileSelect(this)">
            <label for="csv_file" 
                   class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors cursor-pointer">
              <i class="fas fa-folder-open mr-2"></i>
              Choose File
            </label>
          </form>
          
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">
            Supports CSV files up to 10MB
          </p>
        </div>

        <!-- Selected File -->
        <div id="selectedFile" class="hidden mt-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-file-csv text-green-600 dark:text-green-400 text-xl mr-3"></i>
              <div>
                <p class="font-medium text-gray-800 dark:text-white" id="fileName"></p>
                <p class="text-sm text-gray-600 dark:text-gray-400" id="fileSize"></p>
              </div>
            </div>
            <button onclick="clearFile()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Upload Progress -->
        <div id="uploadProgress" class="hidden mt-6">
          <div class="mb-2 flex justify-between">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Uploading...</span>
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="progressPercent">0%</span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div id="progressBar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>

        <!-- Upload Button -->
        <div class="mt-8">
          <button type="submit" 
                  form="uploadForm"
                  id="uploadButton"
                  class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
            <i class="fas fa-upload"></i>
            <span>Upload CSV File</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Preview Card (shown after upload) -->
    <div id="previewCard" class="hidden mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Upload Preview</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          <span id="previewCount">0</span> records found
        </p>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-900">
            <tr id="previewHeaders">
              <!-- Headers will be inserted here -->
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="previewRows">
            <!-- Rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Right Column: Instructions & Template -->
  <div class="lg:col-span-1">
    <!-- Instructions Card -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
          <i class="fas fa-info-circle text-blue-500 mr-2"></i>
          Instructions
        </h3>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          <div class="flex items-start">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mt-1">
              <span class="text-blue-600 dark:text-blue-400 font-semibold">1</span>
            </div>
            <div class="ml-3">
              <h4 class="font-medium text-gray-800 dark:text-white">Download Template</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                Use the template below to ensure proper formatting
              </p>
            </div>
          </div>
          
          <div class="flex items-start">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mt-1">
              <span class="text-green-600 dark:text-green-400 font-semibold">2</span>
            </div>
            <div class="ml-3">
              <h4 class="font-medium text-gray-800 dark:text-white">Fill Student Data</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                Fill in the required fields for each student
              </p>
            </div>
          </div>
          
          <div class="flex items-start">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mt-1">
              <span class="text-purple-600 dark:text-purple-400 font-semibold">3</span>
            </div>
            <div class="ml-3">
              <h4 class="font-medium text-gray-800 dark:text-white">Upload CSV</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                Upload the completed CSV file using the form
              </p>
            </div>
          </div>
          
          <div class="flex items-start">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center mt-1">
              <span class="text-amber-600 dark:text-amber-400 font-semibold">4</span>
            </div>
            <div class="ml-3">
              <h4 class="font-medium text-gray-800 dark:text-white">Review & Confirm</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                Review the data before final submission
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Template Download Card -->
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
          <i class="fas fa-download text-green-500 mr-2"></i>
          CSV Template
        </h3>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Download the CSV template with the correct column headers and format.
        </p>
        
        <a href="{% url 'students:download-csv' %}" 
           class="w-full flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
          <i class="fas fa-file-download mr-2"></i>
          Download Template
        </a>
        
        <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Required Columns:</h4>
          <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
            <li><code>registration_number</code> - Unique student ID</li>
            <li><code>surname</code> - Student's surname</li>
            <li><code>firstname</code> - Student's first name</li>
            <li><code>gender</code> - Male or Female</li>
            <li><code>parent_number</code> - Guardian's phone</li>
            <li><code>address</code> - Student's address</li>
            <li><code>current_class</code> - Class name</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Tips Card -->
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
          <i class="fas fa-lightbulb text-amber-500 mr-2"></i>
          Tips & Guidelines
        </h3>
      </div>
      <div class="p-6">
        <div class="space-y-3">
          <div class="flex items-start text-sm">
            <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
            <span class="text-gray-600 dark:text-gray-400">Use the exact column names from the template</span>
          </div>
          <div class="flex items-start text-sm">
            <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
            <span class="text-gray-600 dark:text-gray-400">Save file as UTF-8 encoded CSV</span>
          </div>
          <div class="flex items-start text-sm">
            <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
            <span class="text-gray-600 dark:text-gray-400">Maximum 1000 records per upload</span>
          </div>
          <div class="flex items-start text-sm">
            <i class="fas fa-exclamation text-red-500 mt-1 mr-2"></i>
            <span class="text-gray-600 dark:text-gray-400">Don't modify column headers</span>
          </div>
          <div class="flex items-start text-sm">
            <i class="fas fa-exclamation text-red-500 mt-1 mr-2"></i>
            <span class="text-gray-600 dark:text-gray-400">Ensure phone numbers are in international format</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // File handling
  let selectedFile = null;

  function handleFileSelect(input) {
    if (input.files.length > 0) {
      selectedFile = input.files[0];
      displaySelectedFile(selectedFile);
      previewCSV(selectedFile);
    }
  }

  function handleDrop(event) {
    event.preventDefault();
    event.target.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/10');
    
    const files = event.dataTransfer.files;
    if (files.length > 0 && files[0].type === 'text/csv') {
      const fileInput = document.getElementById('csv_file');
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(files[0]);
      fileInput.files = dataTransfer.files;
      
      selectedFile = files[0];
      displaySelectedFile(selectedFile);
      previewCSV(selectedFile);
    } else {
      alert('Please drop a CSV file only.');
    }
  }

  function displaySelectedFile(file) {
    const uploadArea = document.getElementById('uploadArea');
    const selectedFileDiv = document.getElementById('selectedFile');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadButton = document.getElementById('uploadButton');
    
    // Hide upload area, show selected file
    uploadArea.classList.add('hidden');
    selectedFileDiv.classList.remove('hidden');
    
    // Update file info
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    
    // Enable upload button
    uploadButton.disabled = false;
  }

  function clearFile() {
    const uploadArea = document.getElementById('uploadArea');
    const selectedFileDiv = document.getElementById('selectedFile');
    const fileInput = document.getElementById('csv_file');
    const uploadButton = document.getElementById('uploadButton');
    const previewCard = document.getElementById('previewCard');
    
    // Reset file input
    fileInput.value = '';
    
    // Show upload area, hide selected file and preview
    uploadArea.classList.remove('hidden');
    selectedFileDiv.classList.add('hidden');
    previewCard.classList.add('hidden');
    
    // Disable upload button
    uploadButton.disabled = true;
    
    selectedFile = null;
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // CSV preview
  function previewCSV(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const text = e.target.result;
      const rows = text.split('\n').slice(0, 11); // Preview first 10 rows
      
      const headers = rows[0].split(',');
      const dataRows = rows.slice(1).filter(row => row.trim() !== '');
      
      // Update preview count
      document.getElementById('previewCount').textContent = dataRows.length;
      
      // Clear previous preview
      const headersRow = document.getElementById('previewHeaders');
      const dataBody = document.getElementById('previewRows');
      headersRow.innerHTML = '';
      dataBody.innerHTML = '';
      
      // Add headers
      headers.forEach(header => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider';
        th.textContent = header.trim();
        headersRow.appendChild(th);
      });
      
      // Add data rows
      dataRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.className = index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-900';
        
        const cells = row.split(',');
        cells.forEach(cell => {
          const td = document.createElement('td');
          td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400';
          td.textContent = cell.trim();
          tr.appendChild(td);
        });
        
        dataBody.appendChild(tr);
      });
      
      // Show preview card
      document.getElementById('previewCard').classList.remove('hidden');
    };
    
    reader.readAsText(file);
  }

  // Upload progress simulation
  document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const uploadProgress = document.getElementById('uploadProgress');
    
    // Show progress bar
    uploadProgress.classList.remove('hidden');
    
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 10;
      if (progress > 100) progress = 100;
      
      progressBar.style.width = progress + '%';
      progressPercent.textContent = Math.round(progress) + '%';
      
      if (progress >= 100) {
        clearInterval(interval);
        setTimeout(() => {
          uploadProgress.classList.add('hidden');
        }, 500);
      }
    }, 200);
  });
</script>
{% endblock %}