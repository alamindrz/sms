{% extends 'base.html' %}
{% load widget_tweaks %}

{% block page_title %}{% if form.instance.pk %}Edit{% else %}Add New{% endif %} Guardian{% endblock %}
{% block page_subtitle %}{% if form.instance.pk %}Update guardian information{% else %}Register a new guardian{% endif %}{% endblock %}

{% block header_actions %}
<a href="{% url 'students:guardian_list' %}" class="btn btn-secondary flex items-center space-x-2">
  <i class="fas fa-arrow-left"></i>
  <span>Back to List</span>
</a>
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'corecode:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'students:student_list' %}">Students</a></li>
<li class="breadcrumb-item"><a href="{% url 'students:guardian_list' %}">Guardians</a></li>
<li class="breadcrumb-item active">{% if form.instance.pk %}Edit{% else %}Add{% endif %}</li>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <!-- Form Header -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-white">
        {% if form.instance.pk %}
          Edit Guardian: {{ form.instance.full_name }}
        {% else %}
          Register New Guardian
        {% endif %}
      </h2>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        Fill in the guardian's information below. Fields marked with * are required.
      </p>
    </div>

    <!-- Form -->
    <form method="post" enctype="multipart/form-data" class="p-6">
      {% csrf_token %}
      
      {% if form.non_field_errors %}
      <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
          <div>
            <h4 class="text-sm font-medium text-red-800 dark:text-red-300">Please correct the errors below</h4>
            <ul class="mt-1 text-sm text-red-700 dark:text-red-400">
              {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Personal Information -->
      <div class="mb-8">
        <h3 class="text-lg font-medium text-gray-800 dark:text-white mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
          <i class="fas fa-user text-indigo-500 mr-2"></i>
          Personal Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Title -->
          <div>
            <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Title
            </label>
            <div class="relative">
              {% render_field form.title class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none" %}
              <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
            </div>
          </div>

          <!-- Surname -->
          <div>
            <label for="{{ form.surname.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Surname *
            </label>
            {% render_field form.surname class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter surname" %}
            {% if form.surname.errors %}
            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.surname.errors }}</div>
            {% endif %}
          </div>

          <!-- First Name -->
          <div>
            <label for="{{ form.firstname.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              First Name *
            </label>
            {% render_field form.firstname class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter first name" %}
            {% if form.firstname.errors %}
            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.firstname.errors }}</div>
            {% endif %}
          </div>

          <!-- Other Name -->
          <div>
            <label for="{{ form.other_name.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Other Name
            </label>
            {% render_field form.other_name class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter other name" %}
          </div>

          <!-- Relationship -->
          <div>
            <label for="{{ form.relationship.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Relationship *
            </label>
            <div class="relative">
              {% render_field form.relationship class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none" %}
              <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
            </div>
            {% if form.relationship.errors %}
            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.relationship.errors }}</div>
            {% endif %}
          </div>

          <!-- Occupation -->
          <div>
            <label for="{{ form.occupation.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Occupation
            </label>
            {% render_field form.occupation class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter occupation" %}
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="mb-8">
        <h3 class="text-lg font-medium text-gray-800 dark:text-white mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
          <i class="fas fa-address-card text-indigo-500 mr-2"></i>
          Contact Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Email -->
          <div>
            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Email Address *
            </label>
            {% render_field form.email class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="guardian@example.com" %}
            {% if form.email.errors %}
            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.email.errors }}</div>
            {% endif %}
          </div>

          <!-- Phone -->
          <div>
            <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Phone Number *
            </label>
            {% render_field form.phone class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="+234 800 000 0000" %}
            {% if form.phone.errors %}
            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.phone.errors }}</div>
            {% endif %}
          </div>

          <!-- Phone 2 -->
          <div>
            <label for="{{ form.phone2.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Secondary Phone
            </label>
            {% render_field form.phone2 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="+234 800 000 0001" %}
          </div>

          <!-- Address -->
          <div class="md:col-span-2">
            <label for="{{ form.address.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Address *
            </label>
            {% render_field form.address rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter full address" %}
            {% if form.address.errors %}
            <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.address.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Photo Upload -->
      <div class="mb-8">
        <h3 class="text-lg font-medium text-gray-800 dark:text-white mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
          <i class="fas fa-camera text-indigo-500 mr-2"></i>
          Photo
        </h3>
        <div class="flex items-center">
          {% if form.instance.photo %}
          <img id="photo-preview" src="{{ form.instance.photo.url }}" alt="Guardian Photo" class="h-32 w-32 rounded-lg object-cover mr-6 border-2 border-gray-300 dark:border-gray-600">
          {% else %}
          <div id="photo-preview" class="h-32 w-32 rounded-lg bg-gradient-to-br from-green-500 to-blue-500 flex items-center justify-center text-white text-4xl font-semibold mr-6">
            <i class="fas fa-user"></i>
          </div>
          {% endif %}
          <div class="flex-1">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
              Upload a clear photo of the guardian. Recommended size: 300x300 pixels.
            </p>
            <div>
              <input type="file" name="{{ form.photo.name }}" id="{{ form.photo.id_for_label }}" 
                     class="hidden" accept="image/*" onchange="previewPhoto(event)">
              <label for="{{ form.photo.id_for_label }}" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                <i class="fas fa-camera mr-2"></i>
                Choose Photo
              </label>
              {% if form.instance.photo %}
              <button type="button" onclick="removePhoto()" class="ml-3 px-4 py-2 border border-red-300 dark:border-red-700 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors">
                <i class="fas fa-trash mr-2"></i>
                Remove Photo
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Account Creation (for new guardians) -->
      {% if not form.instance.pk %}
      <div class="mb-8 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <i class="fas fa-user-plus text-blue-500 text-lg mt-1"></i>
          </div>
          <div class="ml-3">
            <h4 class="text-sm font-medium text-blue-800 dark:text-blue-300">User Account Creation</h4>
            <p class="text-sm text-blue-700 dark:text-blue-400 mt-1">
              After saving, you can create a user account for this guardian to access the parent portal.
              They will receive a welcome email with login instructions.
            </p>
            <div class="mt-2 flex items-center text-sm text-gray-600 dark:text-gray-400">
              <i class="fas fa-info-circle mr-2"></i>
              Account will be created automatically if email is provided
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Form Actions -->
      <div class="pt-6 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div class="text-sm text-gray-500 dark:text-gray-400">
          <i class="fas fa-shield-alt mr-1"></i>
          All information is securely stored
        </div>
        <div class="flex items-center space-x-4">
          <a href="{% url 'students:guardian_list' %}" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            Cancel
          </a>
          <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors flex items-center space-x-2">
            <i class="fas fa-save"></i>
            <span>{% if form.instance.pk %}Update Guardian{% else %}Create Guardian{% endif %}</span>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Existing Students Section (for editing) -->
  {% if form.instance.pk and form.instance.students.all %}
  <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Associated Students</h3>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        {{ form.instance.students.all|length }} student{{ form.instance.students.all|pluralize }} linked to this guardian
      </p>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for student in form.instance.students.all %}
        <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              {% if student.passport %}
              <img src="{{ student.passport.url }}" alt="{{ student.full_name }}" class="h-12 w-12 rounded-full object-cover">
              {% else %}
              <div class="h-12 w-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-semibold">
                {{ student.firstname|first|upper }}{{ student.surname|first|upper }}
              </div>
              {% endif %}
            </div>
            <div class="ml-4 flex-1">
              <h4 class="font-medium text-gray-800 dark:text-white">{{ student.full_name }}</h4>
              <div class="flex items-center justify-between mt-1">
                <span class="text-sm text-gray-600 dark:text-gray-400">{{ student.student_number }}</span>
                <span class="text-xs px-2 py-0.5 rounded-full 
                  {% if student.status == 'active' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300
                  {% else %}bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-300{% endif %}">
                  {{ student.get_status_display }}
                </span>
              </div>
            </div>
          </div>
          <div class="mt-3 flex items-center space-x-3">
            <a href="{% url 'students:student_detail' student.pk %}" 
               class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
              <i class="fas fa-eye mr-1"></i>
              View
            </a>
            <a href="{% url 'students:student_update' student.pk %}" 
               class="text-sm text-blue-600 dark:text-blue-400 hover:underline">
              <i class="fas fa-edit mr-1"></i>
              Edit
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
  // Photo preview
  function previewPhoto(event) {
    const input = event.target;
    const preview = document.getElementById('photo-preview');
    
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        // Replace the preview div with an image
        if (preview.tagName.toLowerCase() === 'div') {
          const img = document.createElement('img');
          img.id = 'photo-preview';
          img.src = e.target.result;
          img.alt = 'Photo Preview';
          img.className = 'h-32 w-32 rounded-lg object-cover mr-6 border-2 border-gray-300 dark:border-gray-600';
          preview.parentNode.replaceChild(img, preview);
        } else {
          preview.src = e.target.result;
        }
      }
      
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Remove photo
  function removePhoto() {
    const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
    const preview = document.getElementById('photo-preview');
    
    // Clear file input
    photoInput.value = '';
    
    // Replace image with default avatar
    const defaultAvatar = document.createElement('div');
    defaultAvatar.id = 'photo-preview';
    defaultAvatar.className = 'h-32 w-32 rounded-lg bg-gradient-to-br from-green-500 to-blue-500 flex items-center justify-center text-white text-4xl font-semibold mr-6';
    defaultAvatar.innerHTML = '<i class="fas fa-user"></i>';
    
    preview.parentNode.replaceChild(defaultAvatar, preview);
    
    // Add hidden input to indicate photo removal
    let removeInput = document.getElementById('remove_photo');
    if (!removeInput) {
      removeInput = document.createElement('input');
      removeInput.type = 'hidden';
      removeInput.name = 'remove_photo';
      removeInput.id = 'remove_photo';
      removeInput.value = 'true';
      document.querySelector('form').appendChild(removeInput);
    }
  }

  // Form validation
  document.querySelector('form').addEventListener('submit', function(e) {
    const requiredFields = document.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        isValid = false;
        field.classList.add('border-red-500');
        
        // Add error message if not exists
        if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('field-error')) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'mt-1 text-sm text-red-600 dark:text-red-400 field-error';
          errorDiv.textContent = 'This field is required';
          field.parentNode.insertBefore(errorDiv, field.nextSibling);
        }
      } else {
        field.classList.remove('border-red-500');
        const errorDiv = field.nextElementSibling;
        if (errorDiv && errorDiv.classList.contains('field-error')) {
          errorDiv.remove();
        }
      }
    });
    
    // Email validation
    const emailField = document.getElementById('{{ form.email.id_for_label }}');
    if (emailField && emailField.value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailField.value)) {
        isValid = false;
        emailField.classList.add('border-red-500');
        
        let errorDiv = emailField.nextElementSibling;
        if (!errorDiv || !errorDiv.classList.contains('field-error')) {
          errorDiv = document.createElement('div');
          errorDiv.className = 'mt-1 text-sm text-red-600 dark:text-red-400 field-error';
          errorDiv.textContent = 'Please enter a valid email address';
          emailField.parentNode.insertBefore(errorDiv, emailField.nextSibling);
        } else {
          errorDiv.textContent = 'Please enter a valid email address';
        }
      }
    }
    
    if (!isValid) {
      e.preventDefault();
      
      // Scroll to first error
      const firstError = document.querySelector('.border-red-500');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
    }
  });

  // Auto-format phone numbers
  const phoneFields = document.querySelectorAll('input[type="tel"], input[name*="phone"]');
  phoneFields.forEach(field => {
    field.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length > 0) {
        // Format as +234 800 000 0000
        if (!value.startsWith('+')) {
          if (value.startsWith('234')) {
            value = '+' + value;
          } else if (value.startsWith('0')) {
            value = '+234' + value.substring(1);
          }
        }
        
        // Add spaces for readability
        if (value.length > 4) {
          value = value.substring(0, 4) + ' ' + value.substring(4);
        }
        if (value.length > 8) {
          value = value.substring(0, 8) + ' ' + value.substring(8);
        }
        if (value.length > 13) {
          value = value.substring(0, 13) + ' ' + value.substring(13);
        }
      }
      
      e.target.value = value;
    });
  });
</script>
{% endblock %}